





na ÚLTIMA LICAO,



VIMOS QUE PODEMOS DROPPAR/REPLACE 1 

GIVEN POLICY  __ APENAS___ SE JÁ


FIZEMOS "uNSET" (ou seja, desvincular) 



ESSA POLICY DE TODAS AS OUTRAS COLUMNS A QUE 

A VINCULAMOS....













ENTRETANTO, NESTA AULA O PROFESSOR NOS EXPLICA QUE 

O PROCESSO 



DE 


DROP/REPLACE/RECREATE DE UMA POLICY 


___NEM SEMPRE__ É IDEAL --------> ISSO PQ _ SE NOSSO 

OBJETIVO 



É APENAS MODIFICAR ALGO NESSA POLICY (sEM A REMOVER),



GERALMENTE É MELHOR APENAS FAZER O __ALTER ___DESSA POLICY,




SEM TER DE recriar essa policy...













PQ SE RECRIÁSSEMOS ESSA POLICY, 



SERÍAMOS FORÇADOS A REAPLICÁ-LA EM TODAS 

NOSSAS COLUMNS, NOVAMENTE....















-- ok... se quisermos apenas alterar 


a definition da policy, PODEMOS 



FACILMENTE FAZER ISSO COM O COMANDO DE "ALTER"...





ESCREVEMOS ASSIM:







SELECT * FROM CUSTOMERS;






-- Alter existing policies -- 



USE ROLE ANALYST_MASKED;

SELECT * FROM CUSTOMERS; -- see if mask is applied 



USE ROLE ACCOUNTADMIN;




ALTER MASKING POLICY DATES
SET BODY -> 
CASE
    WHEN CURRENT_ROLE() IN ('ANALYST_FULL', 'ACCOUNTADMIN') THEN VAL
    ELSE DATE_FROM_PARTS(1111, 11, 11)::DATE -- returns 0001-01-01 00:00:00
END;





--------------------------







-- OU SEJA, QUEREMOS ALTERAR ESSA COLUMN DE "DATE",


-- QUEREMOS VINCULAR A MASKING POLICY DE 


-- "DATES_POLICY" A ELA...







-- SE JÁ TIVERMOS ESSA MASKING POLICY DE "DATES_POLICY',



-- PODEMOS ALTERAR SUA DEFINICAO 



-- COM O COMANDO 

-- DE 



-- "ALTER MASKING POLICY DATES_POLICY SET BODY -> DEFINICAO DA MASK"...















OK... MAS É CLARO QUE ESSA POLICY AINDA NAO EXISTE, POR ISSO 

DEVEMOS A CRIAR, COM ESTE COMANDO:





-- Create actual policy (with things we dont want/are wrong)

CREATE OR REPLACE MASKING POLICY DATES_POLICY
    AS (VAL DATE) RETURNS DATE ->
        CASE
            WHEN CURRENT_ROLE() IN('ANALYST_MASKED') THEN VAL
            ELSE 'DUMMY'
            END;



-----------------------------------------




-- Alter policy
ALTER MASKING POLICY DATES_POLICY
SET BODY -> 
CASE
    WHEN CURRENT_ROLE() IN ('ANALYST_FULL', 'ACCOUNTADMIN') THEN VAL
    ELSE DATE_FROM_PARTS(1111, 11, 11)::DATE -- returns 0001-01-01 00:00:00
END;

















--> DEPOIS DISSO,

DEVEMOS _ ASSIGNAR NOSSA MASKING_POLICY A ALGUMA 
COLUMN DE NOSSAS TABLES...

NO CASO, SERÁ A COLUMN DE 



"CREATE_DATE",



na table de "CUSTOMERS"....






PARA ASSIGNAR A MASK A ESSA COLUMN,


ESCREVEMOS:









ALTER TABLE CUSTOMERS 
MODIFY COLUMN CREATE_DATE 
SET MASKING POLICY DATES_POLICY;





DEPOIS PODEMOS CHECAR, COM O ROLE DE 

ANALYST_MASKED, se essa column está com a mask definida 

a si....




ex:










USE ROLE ANALYST_MASKED;



SELECT * FROM  CUSTOMERS;

















OK... FUNCIONOU.















---> ISSO É OUTRA COISA QUE DEVEMOS TER EM MENTE:





SE TEMOS UMA JÁ EXISTING 



POLICY, 

MTAS VEZES É MELHOR, EM VEZ DE FAZER REPLACE DESSA 
POLICY,


USAR __ O "ALTER MASKING POLICY",


PARA ENTAO 

SÓ MUDAR A DEFINICAO DA MASKING POLICY (sem ter 
de reaplicar  essa policy em todas suas columns mais uma vez)...


